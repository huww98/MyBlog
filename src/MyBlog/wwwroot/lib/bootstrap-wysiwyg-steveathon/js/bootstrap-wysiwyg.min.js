!function(t){"use strict";var e=function(e,n,a){var o,i,r,l=null,s=0;a||(a={});var d=function(){s=a.leading===!1?0:t.now(),l=null,r=e.apply(o,i),l||(o=i=null)};return function(){var c=t.now();s||a.leading!==!1||(s=c);var u=n-(c-s);return o=this,i=arguments,0>=u||u>n?(l&&(clearTimeout(l),l=null),s=c,r=e.apply(o,i),l||(o=i=null)):l||a.trailing===!1||(l=setTimeout(d,u)),r}},n=function(e){var n=t.Deferred(),a=new FileReader;return a.onload=function(t){n.resolve(t.target.result)},a.onerror=n.reject,a.onprogress=n.notify,a.readAsDataURL(e),n.promise()};t.fn.cleanHtml=function(e){if(t(this).data("wysiwyg-html-mode")===!0&&(t(this).html(t(this).text()),t(this).attr("contenteditable",!0),t(this).data("wysiwyg-html-mode",!1)),e===!0&&t(this).parent().is("form")){var n=t(this).html;if(t(n).has("img").length){var a=t("img",t(n)),o=[],i=t(this).parent();t.each(a,function(e,n){t(n).attr("src").match(/^data:image\/.*$/)&&(o.push(a[e]),t(i).prepend("<input value='"+t(n).attr("src")+"' type='hidden' name='postedimage/"+e+"' />"),t(n).attr("src","postedimage/"+e))})}}var r=t(this).html();return r&&r.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},t.fn.wysiwyg=function(a){var o,i,r,l=this,s=function(){i.activeToolbarClass&&t(i.toolbarSelector).find(r).each(function(){var e=t(this).data(i.commandRole).split(" "),n=e[0];e.length>1&&document.queryCommandEnabled(n)&&document.queryCommandValue(n)===e[1]?t(this).addClass(i.activeToolbarClass):1===e.length&&document.queryCommandEnabled(n)&&document.queryCommandState(n)?t(this).addClass(i.activeToolbarClass):t(this).removeClass(i.activeToolbarClass)})},d=function(t,n){var a=t.split(" "),o=a.shift(),r=a.join(" ")+(n||""),d=t.split("-");1===d.length?e(document.execCommand(o,!1,r),i.keypressTimeout):"format"===d[0]&&2===d.length&&e(document.execCommand("formatBlock",!1,d[1]),i.keypressTimeout),l.trigger("change"),s()},c=function(n){t.each(n,function(t,n){l.keydown(t,function(t){l.attr("contenteditable")&&l.is(":visible")&&(t.preventDefault(),t.stopPropagation(),e(d(n),i.keypressTimeout))}).keyup(t,function(t){l.attr("contenteditable")&&l.is(":visible")&&(t.preventDefault(),t.stopPropagation())})}),l.keyup(function(){l.trigger("change")})},u=function(){var t,e;return window.getSelection?(t=window.getSelection(),t.getRangeAt&&t.rangeCount&&(e=t.getRangeAt(0))):document.selection&&(e=document.selection.createRange()),e},m=function(){o=u()},h=function(){var t;if(window.getSelection||document.createRange){if(t=window.getSelection(),o){try{t.removeAllRanges()}catch(e){document.body.createTextRange().select(),document.selection.empty()}t.addRange(o)}}else document.selection&&o&&o.select()},f=function(){if(t(l).data("wysiwyg-html-mode")!==!0){var e=t(l).html(),n=t("<pre />");t(n).append(document.createTextNode(e)),t(n).attr("contenteditable",!0),t(l).html(" "),t(l).append(t(n)),t(l).attr("contenteditable",!1),t(l).data("wysiwyg-html-mode",!0),t(n).focus()}else t(l).html(t(l).text()),t(l).attr("contenteditable",!0),t(l).data("wysiwyg-html-mode",!1),t(l).focus()},p=function(a){l.focus(),t.each(a,function(a,o){/^image\//.test(o.type)?t.when(n(o)).done(function(t){e(d("insertimage",t),i.keypressTimeout),l.trigger("image-inserted")}).fail(function(t){i.fileUploadError("file-reader",t)}):i.fileUploadError("unsupported-file-type",o.type)})},g=function(t,n){h(),document.queryCommandSupported("hiliteColor")&&e(document.execCommand("hiliteColor",!1,n||"transparent"),i.keypressTimeout),m(),t.data(i.selectionMarker,n)},y=function(n,a){n.find(r).click(function(){h(),l.focus(),"html"===t(this).data(a.commandRole)?f():e(d(t(this).data(a.commandRole)),a.keypressTimeout),m()}),n.find("[data-toggle=dropdown]").click(h),n.find("input[type=text][data-"+a.commandRole+"]").on("webkitspeechchange change",function(){var n=this.value;this.value="",h(),n&&(l.focus(),e(d(t(this).data(a.commandRole),n),a.keypressTimeout)),m()}).on("focus",function(){var e=t(this);e.data(a.selectionMarker)||(g(e,a.selectionColor),e.focus())}).on("blur",function(){var e=t(this);e.data(a.selectionMarker)&&g(e,!1)}),n.find("input[type=file][data-"+a.commandRole+"]").change(function(){h(),"file"===this.type&&this.files&&this.files.length>0&&p(this.files),m(),this.value=""})},v=function(){l.on("dragenter dragover",!1).on("drop",function(t){var e=t.originalEvent.dataTransfer;t.stopPropagation(),t.preventDefault(),e&&e.files&&e.files.length>0&&p(e.files)})};return i=t.extend(!0,{},t.fn.wysiwyg.defaults,a),r="a[data-"+i.commandRole+"],button[data-"+i.commandRole+"],input[type=button][data-"+i.commandRole+"]",c(i.hotKeys),""!==t(this).attr("placeholder")&&(t(this).addClass("placeholderText"),t(this).html(t(this).attr("placeholder")),t(this).bind("focus",function(){""!==t(this).attr("placeholder")&&t(this).text()===t(this).attr("placeholder")&&(t(this).removeClass("placeholderText"),t(this).html(""))}),t(this).bind("blur",function(){""!==t(this).attr("placeholder")&&""===t(this).text()&&(t(this).addClass("placeholderText"),t(this).html(t(this).attr("placeholder")))})),i.dragAndDropImages&&v(),y(t(i.toolbarSelector),i),l.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){m(),s()}),t(window).bind("touchend",function(t){var e=l.is(t.target)||l.has(t.target).length>0,n=u(),a=n&&n.startContainer===n.endContainer&&n.startOffset===n.endOffset;(!a||e)&&(m(),s())}),this},t.fn.wysiwyg.defaults={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,fileUploadError:function(t,e){console.log("File upload error",t,e)}}}(window.jQuery);